---
title: 电网项目
date: 2024-07-08 13:31:21
permalink: /pages/1a439e/
sidebar: auto
categories:
  - zk
tags:
  - 
author: 
  name: asafield
  link: https://github.com/Asafield
---

create date: 2023-08-21 17:14  
Status: #idea  
Tags: [[嵌入式]]

---

# 电网项目
## 上位机界面添加

[匿名上位机传输测试](匿名上位机传输测试.md)

## flash芯片添加
>基于存储数据的需要，应在原本的模块中添加flash模块

### 选型
- 大小: 4M。存放数据长达一年以上，经过计算，以5分钟存储一组数据来说，需要大小为2MB的大小的flash

## 引脚分配
![image.png](https://pic-1312640559.cos.ap-chengdu.myqcloud.com//img/20240108133358.png)

### flash芯片原理
![Drawing 2024-01-09 13.48.41.excalidraw](Drawing%202024-01-09%2013.48.41.excalidraw.md)

#### 扇区擦除
注意几个地方

发送24位地址，因为一次只能发送1个字节，所以需要发3次，如果配置的是MSB优先，则先发最高8位，再发中间8位，再发低8位。

这里难以理解的是“扇区地址”乘以4096

事实上，这里传入的不是扇区地址，而是扇区的id号，所以需要再乘以4096（每个扇区4Kbyte字节），得出该扇区的起始地址。

128个块，每块16个扇区，则一共有2048个扇区，则扇区id从0到2047。

怎么知道一个地址落在哪个扇区内呢？

通常，给一个地址，比如0x0000FF（255），用这个地址除以4096，得到整数结果，就是所在的扇区号。因为一个扇区4096个字节，类似于进制每4096进1，所以除以进制后取整就能得到扇区号。再把扇区号乘以4096，就能得到扇区的首地址。

比如地址0x7FFFFF（8,388,607），除以4096，结果为2,047.999755859375…，取整为2047，刚好是最后一个扇区id，再把2047乘以4096，就能得到最后一个扇区的起始地址8,384,512，也就是0x7FF000，经验证是正确的。

其实很好理解，如果一个扇区是10单位的大小，那么0~9就会落入第一个扇区，10~19就会落入第二个扇区……类比理解。

- [x] 为什么是一个扇区到一页分级写入呢？ 📅 2024-01-10 ✅ 2024-01-25
因为使用的芯片好像最多一次写入就是一页，所以扇区的写入需要分成页，且页写入不需要对齐


### 流程图
![电网项目传感节点架构设计.excalidraw](电网项目传感节点架构设计.excalidraw.md)
### 调试日志
#### 20240305
- 状态：外置flash能在第一次写入后成功读出，但后续几次都失败了，读出的结果为全1,疑似为被擦除的结果
- 验证：使用测试程序进行假设的验证：
	- 测试结果无问题，假设不成立
- 对比测试程序与落地程序：
	- 成功，原程序在修改了写入地址之后就能成功读出，推测问题是原程序是在同一个位置写入，但读出的位置在随着数据的增多而后移，读出的位置还没有写入，所以产生了错误。

#### 20240511
##### 功耗控制
- 休眠功耗：
	- 以下输入电压为5V
	- 关闭外设的情况：
		- 关闭mpu6050与scl3300的低功耗模式：2.38mA
		- mpu6050进入低功耗模式: 1.95mA左右
		- SCL3300进入低功耗模式：800uA左右
		- 在mpu6050与SCL3300同时进入低功耗模式，没有温度传感器与flash的v2.2模块功耗在30uA左右，而拆掉温度传感器的v2.3版本功耗在800uA左右，进入power down模式时功耗降低至200uA。初步猜测是flash的功耗过高
			- 尝试对flash的IO引脚进行设置
		- 网上有人实现了使用flash时功耗在5uA（单指flash的功耗）以下

#### 20240531
##### flash功能
- 数据保存机制：
	- 在空间足够时，应该能在掉电之后继续在上次写入的位置写入
	- 能够知道写入了多少数据
	- 在达到上限时的选择：更新最后一个值/或是停止写入
- 方案
	- 使用文件系统，如适用于嵌入式的FatFs文件系统，对于SPI Flash or SD Card之类的大容量设备，这是一种更高效的方式，为了存储与管理数据，而在存储介质上建立的一种组织结构，这些结构包括操作系统引导区、目录和文件。常见的windows下的文件系统包括FAT32、NTFS、exFAT。在使用文件系统前，要先对存储介质进行格式化。格式化先擦除原先内容，在存储介质上新建一个文件分配表和目录。这样，文件系统就可能记录数据存储的物理地址，剩余空间。
	- 自己设计文件存储结构：
		- 下次存储起始位置 --4byte
		- 休眠后继续工作
		- 断电重启后继续工作
		- 存储空间已满时不再写入
		- 数据采集模式（不断写入）
		- 数据读出模式（采集完成后对数据的读出）
		- 数据清除模式
		- 三种模式的切换
# references
[低功耗配置IO注意事项_gpio高阻低功耗-CSDN博客](https://blog.csdn.net/hanyupeng123/article/details/109325263)
[FatFs文件系统 - 孤情剑客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/The-explosion/p/13170732.html)
